{"version":3,"file":"handle-mock.js","names":["mongoose","require","mockProxy","module","exports","_ref","_asyncToGenerator","cb","op","modelName","model","_this$_mongooseOption","_mongooseOptions","Model","mock","__mocks","err","Error","includes","Array","isArray","map","item","_iterator","_createForOfIteratorHelper","_step","s","n","done","doc","value","e","validateSync","f","lean","rawResult","toObject","_x","apply","arguments"],"sources":["../../src/mocks/handle-mock.js"],"sourcesContent":["const mongoose = require('mongoose');\nconst mockProxy = require('../mock-proxy');\n\nmodule.exports = async function (cb) {\n  const {\n    op,\n    model: { modelName },\n    _mongooseOptions = {},\n  } = this;\n  const Model = mongoose.model(modelName);\n\n  let mock = mockProxy.__mocks[modelName] && mockProxy.__mocks[modelName][op];\n\n  let err = null;\n\n  if (mock instanceof Error) {\n    err = mock;\n  }\n\n  if (typeof mock === 'function') {\n    mock = await mock(this);\n  }\n\n  if (!mock && op === 'save') {\n    mock = this;\n  }\n\n  if (!mock && op === '$save') {\n    mock = this;\n  }\n\n  if (\n    mock &&\n    !(mock instanceof Model) &&\n    ![\n      'remove',\n      'deleteOne',\n      'deleteMany',\n      'update',\n      'updateOne',\n      'updateMany',\n      'count',\n      'countDocuments',\n      'estimatedDocumentCount',\n      'distinct',\n    ].includes(op)\n  ) {\n    mock = Array.isArray(mock)\n      ? mock.map((item) => new Model(item))\n      : new Model(mock);\n\n    if (op === 'insertMany') {\n      if (!Array.isArray(mock)) mock = [mock];\n\n      for (const doc of mock) {\n        const e = doc.validateSync();\n        if (e) throw e;\n      }\n    }\n\n    if (_mongooseOptions.lean || _mongooseOptions.rawResult) {\n      mock = Array.isArray(mock)\n        ? mock.map((item) => item.toObject())\n        : mock.toObject();\n    }\n  }\n\n  if (cb) {\n    return cb(err, mock);\n  }\n\n  if (err) {\n    throw err;\n  }\n\n  return mock;\n};\n"],"mappings":"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"}